generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

/* ================================================
   ENUMS – each value on its own line
   ================================================ */
enum MatchStatus {
  PENDING
  ACCEPTED
  REJECTED
}

enum Sex {
  MALE
  FEMALE
}

enum AwardType {
  CERTIFICATE
  REWARD
  PRIZE
  DIPLOMA
}

enum RequestStatus {
  PENDING
  ACCEPTED
  REJECTED
}

enum AvailabilityPeriod {
  MORNING
  DAY
  NIGHT
}

enum CertificationStatus {
  PENDING
  APPROVED
  REJECTED
  REVOKED
}

enum IssuerType {
  KENNEL
  CLUB
}

enum EnrollmentStatus {
  APPLIED
  APPROVED
  REJECTED
  CANCELLED
}

enum CompetitionStatus {
  SCHEDULED
  ONGOING
  COMPLETED
  CANCELLED
}

enum ClubMemberRole {
  OWNER
  EMPLOYEE
  MEMBER
}

enum ClubCertifierStatus {
  PENDING
  APPROVED
  REJECTED
  REVOKED
}

enum KennelMemberRole {
  OWNER
  EMPLOYEE
  MEMBER
}

enum EntryStatus {
  PENDING
  ACCEPTED
  REJECTED
}

/* ================================================
   MODELS – FINAL LOCK V2 (Club-only education)
   ================================================ */

model User {
  id                              Int       @id @default(autoincrement())
  email                           String    @unique
  password                        String
  profile                         Profile?
  roles                           UserRole[]
  sentMatches                     Match[]   @relation("MatchOwner")
  receivedMatches                 Match[]   @relation("MatchSitter")
  kennelMemberships               KennelMember[]
  membershipRequests              KennelMembershipRequest[] @relation("UserKennelMembershipRequests")
  competitionEntries              CompetitionEntry[]
  sentMessages                    Message[]
  petsOwned                       Pet[]     @relation("PetOwner")
  awardsIssued                    Award[]   @relation("AwardIssuer")
  clubMemberships                 ClubMember[]
  courseEnrollments               CourseEnrollment[]
  clubCertificationsGranted       ClubCertifier[] @relation("CertifierGrantedTo")
  clubCertificationsIssued        ClubCertifier[] @relation("CertifierIssuedBy")
  clubCertifiersProcessed         ClubCertifier[] @relation("CertifierProcessedByAdmin")
  certifiedCourses                CourseCertifierAssignment[]
  certificationsVerified          Certification[] @relation("CertificationVerifiedByUser")
  competitionAwardsAssigned       CompetitionAward[] @relation("CompetitionAwardAwardedBy")
  competitionsAllowedToAward      CompetitionAllowedAwarder[] @relation("CompetitionAllowedAwarderUser")
  competitionAllowedAwarderNominated CompetitionAllowedAwarder[] @relation("CompetitionAllowedAwarderNominatedBy")
  competitionAllowedAwarderProcessed CompetitionAllowedAwarder[] @relation("CompetitionAllowedAwarderProcessedBy")
  userCertificateSubmissions      UserCertificateSubmission[]
  processedCertificateSubmissions UserCertificateSubmission[] @relation("UserCertificateSubmissionProcessedBy")
  certifications                  Certification[]
  createdAt                       DateTime  @default(now())
  updatedAt                       DateTime  @updatedAt
}

model Role {
  id    Int       @id @default(autoincrement())
  name  String    @unique
  users UserRole[]
}

model UserRole {
  userId Int
  roleId Int
  user   User @relation(fields: [userId], references: [id])
  role   Role @relation(fields: [roleId], references: [id])
  @@id([userId, roleId])
}

/**
 * ---------- PROFILE ----------
 */
model Profile {
  id                Int                     @id @default(autoincrement())
  firstName         String?
  lastName          String?
  bio               String?
  location          String?
  // Sitter-specific fields
  pricePerDay       Int?
  publicEmail       String?
  publicPhone       String?
  sitterDescription String?
  availability      SitterAvailability[]
  services          SitterService[]
  breedExperience   SitterBreedExperience[]
  user              User                    @relation(fields: [userId], references: [id])
  userId            Int                     @unique
}

/**
 * ---------- MATCH ----------
 */
model Match {
  id        Int         @id @default(autoincrement())
  ownerId   Int
  sitterId  Int
  status    MatchStatus @default(PENDING)
  owner     User        @relation("MatchOwner", fields: [ownerId], references: [id])
  sitter    User        @relation("MatchSitter", fields: [sitterId], references: [id])
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  messages  Message[]

  @@unique([ownerId, sitterId])
}

/**
 * ==================== KENNEL ====================
 */
model Kennel {
  id                  Int       @id @default(autoincrement())
  name                String    @unique
  location            String?
  members             KennelMember[]
  pets                Pet[]
  litters             Litter[]
  images              Image[]
  membershipRequests  KennelMembershipRequest[] @relation("KennelMembershipRequests")
  petRequests         KennelPetRequest[]        @relation("KennelPetRequests")
  issuedPetCertifications Certification[] @relation("KennelIssuedCertifications")
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
}

model KennelMember {
  kennelId Int
  userId   Int
  role     KennelMemberRole @default(MEMBER)
  kennel   Kennel           @relation(fields: [kennelId], references: [id])
  user     User             @relation(fields: [userId], references: [id])

  @@id([kennelId, userId])
  @@index([kennelId])
  @@index([userId])
}

/**
 * ---------- PET ----------
 */
model Pet {
  id                 Int                @id @default(autoincrement())
  name               String?
  species            String?
  breed              String?
  color              String?
  sex                Sex?
  age                Int?
  ownerId            Int?
  kennelId           Int?
  owner              User?              @relation("PetOwner", fields: [ownerId], references: [id])
  kennel             Kennel?            @relation(fields: [kennelId], references: [id])
  certifications     Certification[]
  courseEnrollments  CourseEnrollment[]
  competitionEntries CompetitionEntry[]
  kennelRequests     KennelPetRequest[] @relation("PetKennelRequests")
  // Family tree
  parentMotherId     Int?
  parentFatherId     Int?
  parentMother       Pet?               @relation("PetChildren", fields: [parentMotherId], references: [id])
  parentFather       Pet?               @relation("PetChildrenFather", fields: [parentFatherId], references: [id])
  children           Pet[]              @relation("PetChildren")
  childrenFather     Pet[]              @relation("PetChildrenFather")
  // Litter
  litter             Litter?            @relation("LitterPets", fields: [litterId], references: [id])
  litterId           Int?
  // Images
  images             Image[]
  // Awards
  awards             Award[]
  // Litter parent roles
  littersAsMother    Litter[]           @relation("PetLitterMother")
  littersAsFather    Litter[]           @relation("PetLitterFather")
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt

  @@unique([name, kennelId])
}

/**
 * ---------- LITTER ----------
 */
model Litter {
  id        Int       @id @default(autoincrement())
  kennelId  Int
  motherId  Int
  fatherId  Int
  birthDate DateTime?
  kennel    Kennel    @relation(fields: [kennelId], references: [id])
  mother    Pet       @relation("PetLitterMother", fields: [motherId], references: [id])
  father    Pet       @relation("PetLitterFather", fields: [fatherId], references: [id])
  pets      Pet[]     @relation("LitterPets")
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@unique([kennelId, motherId, fatherId])
}

/**
 * ---------- IMAGE (single source of truth) ----------
 */
model Image {
  id        Int      @id @default(autoincrement())
  url       String
  alt       String?
  petId     Int?
  kennelId  Int?
  awardId   Int?     @unique // ← ONE-TO-ONE: only one image per award
  pet       Pet?     @relation(fields: [petId], references: [id])
  kennel    Kennel?  @relation(fields: [kennelId], references: [id])
  award     Award?   @relation(fields: [awardId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([petId])
  @@index([kennelId])
  @@index([awardId])
}

/* -------------------------------------------------
   AWARD – cleaned up (no kennelId, no claimable)
   ------------------------------------------------- */
model Award {
  id               Int       @id @default(autoincrement())
  type             AwardType
  name             String
  isOfficial       Boolean   @default(false)
  issuerId         Int
  clubId           Int?
  competitionId    Int?
  petId            Int?
  issuer           User      @relation("AwardIssuer", fields: [issuerId], references: [id])
  club             Club?     @relation(fields: [clubId], references: [id])
  competition      Competition? @relation(fields: [competitionId], references: [id])
  competitionAwards CompetitionAward[]
  pet              Pet?      @relation(fields: [petId], references: [id])
  image            Image?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@unique([name])
  @@index([clubId])
  @@index([competitionId])
}

/**
 * ---------- MESSAGE ----------
 */
model Message {
  id        Int      @id @default(autoincrement())
  matchId   Int?
  senderId  Int
  message   String
  timestamp DateTime @default(now())
  match     Match?   @relation(fields: [matchId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  sender    User     @relation(fields: [senderId], references: [id])

  @@index([matchId, timestamp])
}

/**
 * ==================== CLUB ====================
 */
model Club {
  id                       Int             @id @default(autoincrement())
  name                     String          @unique
  membershipType           String
  verificationStatus       String          @default("PENDING")
  members                  ClubMember[]
  awardsIssued             Award[]
  competitions             Competition[]
  createdAt                DateTime        @default(now())
  updatedAt                DateTime        @updatedAt
  coursesIssued            Course[]        @relation("ClubCourses")
  issuedUserCertifications Certification[] @relation("ClubIssuedCertifications")
  certifiers               ClubCertifier[]
}

model ClubCertifier {
  id                     Int                 @id @default(autoincrement())
  clubId                 Int
  userId                 Int // user who is nominated to be a certifier
  grantedById            Int? // user (club owner/employee) who nominated/granted
  status                 ClubCertifierStatus @default(PENDING)
  requestedAt            DateTime            @default(now())
  processedAt            DateTime?
  processedByAdminId     Int? // platform admin user id who approved/rejected
  notes                  String?
  verifiedCertifications Certification[]
  competitions           Competition[]
  club                   Club                @relation(fields: [clubId], references: [id])
  user                   User                @relation("CertifierGrantedTo", fields: [userId], references: [id])
  grantedBy              User?               @relation("CertifierIssuedBy", fields: [grantedById], references: [id])
  processedByAdmin       User?               @relation("CertifierProcessedByAdmin", fields: [processedByAdminId], references: [id])

  @@unique([clubId, userId])
  @@index([status])
  @@index([processedByAdminId])
}

model ClubMember {
  clubId   Int
  userId   Int
  status   String         @default("PENDING")
  role     ClubMemberRole @default(MEMBER)
  joinedAt DateTime?      @default(now())
  club     Club           @relation(fields: [clubId], references: [id])
  user     User           @relation(fields: [userId], references: [id])

  @@id([clubId, userId])
}

/**
 * --------- REQUESTS ------------
 */
model KennelMembershipRequest {
  id        Int           @id @default(autoincrement())
  kennelId  Int
  userId    Int
  message   String?
  status    RequestStatus @default(PENDING)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  type      String        @default("MEMBERSHIP")
  kennel    Kennel        @relation("KennelMembershipRequests", fields: [kennelId], references: [id])
  user      User          @relation("UserKennelMembershipRequests", fields: [userId], references: [id])

  @@unique([kennelId, userId])
  @@index([kennelId])
  @@index([userId])
}

model KennelPetRequest {
  id        Int           @id @default(autoincrement())
  kennelId  Int
  petId     Int
  message   String?
  status    RequestStatus @default(PENDING)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  type      String        @default("PET_LINK")
  kennel    Kennel        @relation("KennelPetRequests", fields: [kennelId], references: [id])
  pet       Pet           @relation("PetKennelRequests", fields: [petId], references: [id])

  @@unique([kennelId, petId])
  @@index([kennelId])
  @@index([petId])
}

/**
 * SITTER: Availability / Services / Breed experience
 */
model SitterAvailability {
  id     Int                @id @default(autoincrement())
  userId Int
  period AvailabilityPeriod
  user   Profile            @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@unique([userId, period])
  @@index([period])
}

model Service {
  id      Int            @id @default(autoincrement())
  name    String         @unique
  sitters SitterService[]
}

model SitterService {
  userId    Int
  serviceId Int
  user      Profile @relation(fields: [userId], references: [userId], onDelete: Cascade)
  service   Service @relation(fields: [serviceId], references: [id])

  @@id([userId, serviceId])
  @@index([serviceId])
}

model SitterBreedExperience {
  userId Int
  breed  String // or connect to normalized Breed table later
  user   Profile @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@unique([userId, breed])
}

/* -------------------------------------------------
   COURSE – Club-only + new fields
   ------------------------------------------------- */
model Course {
  id                Int       @id @default(autoincrement())
  title             String
  description       String?
  issuerType        IssuerType @default(CLUB)
  clubId            Int
  isHidden          Boolean   @default(false)
  isAvailable       Boolean   @default(true)
  unavailableReason String?
  maxParticipants   Int?
  club              Club      @relation("ClubCourses", fields: [clubId], references: [id])
  certifiers        CourseCertifierAssignment[]
  createdAt         DateTime  @default(now())
  certifications    Certification[]
  enrollments       CourseEnrollment[]
  @@index([clubId])
}

model CourseCertifierAssignment {
  courseId   Int
  userId     Int
  assignedAt DateTime @default(now())
  role       String?  // e.g. "lead", "assistant" — future-proof

  course     Course   @relation(fields: [courseId], references: [id])
  user       User     @relation(fields: [userId], references: [id])

  @@id([courseId, userId])
  @@index([courseId])
  @@index([userId])
}

/* -------------------------------------------------
   ENROLLMENTS & ENTRIES – petId required
   ------------------------------------------------- */
model CourseEnrollment {
  id          Int       @id @default(autoincrement())
  courseId    Int
  userId      Int?
  petId       Int
  status      EnrollmentStatus @default(APPLIED)
  appliedAt   DateTime  @default(now())
  processedAt DateTime?
  processedBy Int?
  notes       String?
  course      Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user        User?     @relation(fields: [userId], references: [id])
  pet         Pet       @relation(fields: [petId], references: [id])
  @@unique([courseId, petId])
  @@index([courseId])
  @@index([status])
}

model CompetitionEntry {
  id            Int       @id @default(autoincrement())
  competitionId Int
  userId        Int?
  petId         Int
  status        EntryStatus @default(PENDING)
  score         Float?
  placement     Int?
  notes         String?
  createdAt     DateTime  @default(now())
  competition   Competition @relation(fields: [competitionId], references: [id], onDelete: Cascade)
  competitionAwards CompetitionAward[]
  user          User?     @relation(fields: [userId], references: [id])
  pet           Pet       @relation(fields: [petId], references: [id])
  @@unique([competitionId, petId])
  @@index([competitionId])
  @@index([status])
}

/* -------------------------------------------------
   CERTIFICATION – issuingKennelId kept (no @deprecated)
   ------------------------------------------------- */
model Certification {
  id                    Int       @id @default(autoincrement())
  courseId              Int
  userId                Int?
  petId                 Int?
  issuingKennelId       Int?
  issuingClubId         Int?
  status                CertificationStatus @default(PENDING)
  certificateUrl        String?   @db.VarChar(500)
  issuedAt              DateTime?
  revokedAt             DateTime?
  notes                 String?   @db.Text
  verifiedByCertifierId Int?
  verifiedByCertifier   ClubCertifier? @relation(fields: [verifiedByCertifierId], references: [id])
  verifiedByUserId      Int?
  verifiedByUser        User?     @relation("CertificationVerifiedByUser", fields: [verifiedByUserId], references: [id])
  course                Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user                  User?     @relation(fields: [userId], references: [id])
  pet                   Pet?      @relation(fields: [petId], references: [id])
  issuingKennel         Kennel?   @relation("KennelIssuedCertifications", fields: [issuingKennelId], references: [id])
  issuingClub           Club?     @relation("ClubIssuedCertifications", fields: [issuingClubId], references: [id])
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@unique([courseId, petId])
  @@unique([courseId, userId])
  @@index([courseId])
  @@index([userId])
  @@index([petId])
  @@index([issuingKennelId])
  @@index([issuingClubId])
}

/* -------------------------------------------------
   COMPETITION – Club-only + new fields
   ------------------------------------------------- */
model Competition {
  id                Int       @id @default(autoincrement())
  title             String
  description       String?
  issuerType        IssuerType @default(CLUB)
  clubId            Int
  certifierId       Int?
  startAt           DateTime?
  endAt             DateTime?
  status            CompetitionStatus @default(SCHEDULED)
  isHidden          Boolean   @default(false)
  isAvailable       Boolean   @default(true)
  unavailableReason String?
  maxEntries        Int?
  club              Club      @relation(fields: [clubId], references: [id])
  certifier         ClubCertifier? @relation(fields: [certifierId], references: [id])
  entries           CompetitionEntry[]
  awards            Award[]
  competitionAwards CompetitionAward[]
  allowedAwarders   CompetitionAllowedAwarder[]
  createdAt         DateTime  @default(now())
  @@index([clubId])
  @@index([status])
  @@index([certifierId])
}

/**
 * CompetitionAllowedAwarder:
 * - join model to nominate and approve users allowed to award for a competition
 */
model CompetitionAllowedAwarder {
  competitionId Int
  userId        Int
  nominatedById Int?
  status        RequestStatus @default(PENDING)
  nominatedAt   DateTime      @default(now())
  processedAt   DateTime?
  processedById Int?
  notes         String?

  competition Competition @relation(fields: [competitionId], references: [id])
  // explicit relation name because we have multiple relations between User and this model
  user        User        @relation("CompetitionAllowedAwarderUser", fields: [userId], references: [id])
  nominatedBy User?       @relation("CompetitionAllowedAwarderNominatedBy", fields: [nominatedById], references: [id])
  processedBy User?       @relation("CompetitionAllowedAwarderProcessedBy", fields: [processedById], references: [id])

  @@id([competitionId, userId])
  @@index([competitionId])
  @@index([userId])
}

/**
 * Bridge model to assign an Award to a competition entry (or to the competition in general)
 */
model CompetitionAward {
  id              Int               @id @default(autoincrement())
  competitionId   Int
  awardId         Int
  entryId         Int? // optional: which entry got the award
  awardedByUserId Int? // user who assigned the award
  competition     Competition       @relation(fields: [competitionId], references: [id], onDelete: Cascade)
  award           Award             @relation(fields: [awardId], references: [id], onDelete: Cascade)
  entry           CompetitionEntry? @relation(fields: [entryId], references: [id])
  awardedBy       User?             @relation("CompetitionAwardAwardedBy", fields: [awardedByUserId], references: [id])
  createdAt       DateTime          @default(now())

  @@unique([competitionId, awardId])
  @@index([competitionId])
  @@index([entryId])
  @@index([awardedByUserId])
}

/**
 * User-submitted official paperwork (for admins to review)
 */
model UserCertificateSubmission {
  id             Int           @id @default(autoincrement())
  userId         Int
  courseId       Int?
  petId          Int? // optional if submission is about a pet
  certificateUrl String?       @db.VarChar(1000)
  notes          String?       @db.Text
  status         RequestStatus @default(PENDING)
  submittedAt    DateTime      @default(now())
  processedAt    DateTime?
  processedById  Int?
  processedBy    User?         @relation("UserCertificateSubmissionProcessedBy", fields: [processedById], references: [id])
  user           User          @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([courseId])
  @@index([petId])
  @@index([status])
}
