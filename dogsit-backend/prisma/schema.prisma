// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

/* ---------- ENUMS ---------- */
enum MatchStatus {
  PENDING
  ACCEPTED
  REJECTED
}

enum Sex {
  MALE
  FEMALE
}

enum AwardType {
  CERTIFICATE
  REWARD
  PRICE
  DIPLOMA
}

/* ---------- MODELS ---------- */
model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  password  String
  profile   Profile?

  // Roles
  roles     UserRole[]

  // Matches
  sentMatches     Match[] @relation("MatchOwner")
  receivedMatches Match[] @relation("MatchSitter")

  // Kennel membership
  kennelMemberships KennelMember[]

  membershipRequests KennelMembershipRequest[] @relation("UserKennelMembershipRequests")

  // Messages
  sentMessages Message[]

  // Pets owned
  petsOwned Pet[] @relation("PetOwner")

  // Awards issued / claimed
  awardsIssued  Award[] @relation("AwardIssuer")
  awardsClaimed Award[] @relation("AwardClaimed")

  // Club membership
  clubMemberships ClubMember[]
  

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Role {
  id    Int        @id @default(autoincrement())
  name  String     @unique
  users UserRole[]
}

model UserRole {
  userId Int
  roleId Int

  user User @relation(fields: [userId], references: [id])
  role Role @relation(fields: [roleId], references: [id])

  @@id([userId, roleId])
  @@unique([userId, roleId])
}

/* ---------- PROFILE ---------- */
model Profile {
  id              Int     @id @default(autoincrement())
  firstName       String?
  lastName        String?
  bio             String?
  location        String?
  dogBreed        String?
  servicesOffered String?
  user            User    @relation(fields: [userId], references: [id])
  userId          Int     @unique
}

/* ---------- MATCH ---------- */
model Match {
  id        Int          @id @default(autoincrement())
  ownerId   Int
  sitterId  Int
  status    MatchStatus  @default(PENDING)

  owner     User         @relation("MatchOwner", fields: [ownerId], references: [id])
  sitter    User         @relation("MatchSitter", fields: [sitterId], references: [id])

  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  messages  Message[]

  @@unique([ownerId, sitterId])
}

/* ---------- KENNEL ---------- */
model Kennel {
  id        Int            @id @default(autoincrement())
  name      String         @unique
  location  String?

  members   KennelMember[]
  pets      Pet[]
  litters   Litter[]
  awards    Award[]
  images    Image[]

  membershipRequests KennelMembershipRequest[] @relation("KennelMembershipRequests")
  petRequests        KennelPetRequest[]        @relation("KennelPetRequests")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model KennelMember {
  kennelId Int
  userId   Int
  role     String

  kennel   Kennel @relation(fields: [kennelId], references: [id])
  user     User   @relation(fields: [userId], references: [id])

  @@id([kennelId, userId])
  @@index([kennelId])
  @@index([userId])
}

/* ---------- PET ---------- */
model Pet {
  id            Int      @id @default(autoincrement())
  name          String?
  species       String?
  breed         String?
  color         String?
  sex           Sex?
  age           Int?
  ownerId       Int?
  kennelId      Int?

  owner         User?    @relation("PetOwner", fields: [ownerId], references: [id])
  kennel        Kennel?  @relation(fields: [kennelId], references: [id])

  kennelRequests KennelPetRequest[] @relation("PetKennelRequests")

  // Family tree
  parentMotherId Int?
  parentFatherId Int?
  parentMother   Pet?     @relation("PetChildren", fields: [parentMotherId], references: [id])
  parentFather   Pet?     @relation("PetChildrenFather", fields: [parentFatherId], references: [id])
  children       Pet[]    @relation("PetChildren")
  childrenFather Pet[]    @relation("PetChildrenFather")

  // Litter
  litter        Litter?  @relation("LitterPets", fields: [litterId], references: [id])
  litterId      Int?

  // Images
  images        Image[]

  // Awards
  awards        Award[]

  // Litter parent roles
  littersAsMother Litter[] @relation("PetLitterMother")
  littersAsFather Litter[] @relation("PetLitterFather")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  @@unique([name, kennelId])
}

/* ---------- LITTER ---------- */
model Litter {
  id        Int      @id @default(autoincrement())
  kennelId  Int
  motherId  Int
  fatherId  Int
  birthDate DateTime?

  kennel    Kennel   @relation(fields: [kennelId], references: [id])
  mother    Pet      @relation("PetLitterMother", fields: [motherId], references: [id])
  father    Pet      @relation("PetLitterFather", fields: [fatherId], references: [id])

  pets      Pet[]    @relation("LitterPets")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  @@unique([kennelId, motherId, fatherId])
}

/* ---------- IMAGE (single source of truth) ---------- */
model Image {
  id        Int      @id @default(autoincrement())
  url       String
  alt       String?
  petId     Int?
  kennelId  Int?
  awardId   Int?     @unique   // ← ONE-TO-ONE: only one image per award

  pet       Pet?     @relation(fields: [petId], references: [id])
  kennel    Kennel?  @relation(fields: [kennelId], references: [id])
  award     Award?   @relation(fields: [awardId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([petId])
  @@index([kennelId])
  @@index([awardId])
}

/* ---------- AWARD ---------- */
model Award {
  id              Int       @id @default(autoincrement())
  type            AwardType
  name            String
  isOfficial      Boolean   @default(false)
  isClaimable     Boolean   @default(false)
  issuerId        Int
  clubId          Int?
  claimedByUserId Int?
  petId           Int?
  kennelId        Int?

  issuer          User      @relation("AwardIssuer", fields: [issuerId], references: [id])
  club            Club?     @relation(fields: [clubId], references: [id])
  claimedBy       User?     @relation("AwardClaimed", fields: [claimedByUserId], references: [id])
  pet             Pet?      @relation(fields: [petId], references: [id])
  kennel          Kennel?   @relation(fields: [kennelId], references: [id])
  image           Image?    // ← ONE-TO-ONE: award has one badge image

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([name, kennelId])
}

/* ---------- MESSAGE ---------- */
model Message {
  id        Int      @id @default(autoincrement())
  matchId   Int?
  senderId  Int
  message   String
  timestamp DateTime @default(now())

  match     Match?   @relation(fields: [matchId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  sender    User     @relation(fields: [senderId], references: [id])

  @@index([matchId, timestamp])
}

/* ---------- CLUB ---------- */
model Club {
  id                 Int          @id @default(autoincrement())
  name               String       @unique
  membershipType     String
  verificationStatus String       @default("PENDING")
  members            ClubMember[]
  awardsIssued       Award[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ClubMember {
  clubId Int
  userId Int
  status String @default("PENDING")

  club   Club @relation(fields: [clubId], references: [id])
  user   User @relation(fields: [userId], references: [id])

  @@id([clubId, userId])
}

/* --------- REQUESTS ------------*/

enum RequestStatus {
  PENDING
  ACCEPTED
  REJECTED
}

// 1. Membership Request (user wants to join kennel staff)
model KennelMembershipRequest {
  id        Int           @id @default(autoincrement())
  kennelId  Int
  userId    Int
  message   String?
  status    RequestStatus @default(PENDING)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  type String @default("MEMBERSHIP")

  kennel    Kennel        @relation("KennelMembershipRequests", fields: [kennelId], references: [id])
  user      User          @relation("UserKennelMembershipRequests", fields: [userId], references: [id])

  @@unique([kennelId, userId])
  @@index([kennelId])
  @@index([userId])
}

// 2. Pet Link Request ("This dog was bred by this kennel")
model KennelPetRequest {
  id        Int           @id @default(autoincrement())
  kennelId  Int
  petId     Int
  message   String?
  status    RequestStatus @default(PENDING)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  type      String       @default("PET_LINK")

  kennel    Kennel        @relation("KennelPetRequests", fields: [kennelId], references: [id])
  pet       Pet           @relation("PetKennelRequests", fields: [petId], references: [id])

  @@unique([kennelId, petId])
  @@index([kennelId])
  @@index([petId])
}